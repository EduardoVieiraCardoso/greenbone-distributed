version: '3.8'

services:
  # ===========================================
  # NATS - Message Queue
  # ===========================================
  nats:
    image: nats:latest
    container_name: greenbone-nats
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # HTTP monitoring
    volumes:
      - ./nats/nats-server.conf:/etc/nats/nats-server.conf:ro
    command: ["-c", "/etc/nats/nats-server.conf"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================
  # Orchestrator - Job Distribution
  # ===========================================
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: greenbone-orchestrator
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - NATS_URL=nats://nats:4222
      - NATS_TOKEN=${NATS_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    restart: unless-stopped

  # ===========================================
  # API - REST Interface
  # ===========================================
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: greenbone-api
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - NATS_URL=nats://nats:4222
      - NATS_TOKEN=${NATS_TOKEN}
      - API_TOKEN=${API_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    restart: unless-stopped

  # ===========================================
  # Webhook - Result Receiver
  # ===========================================
  webhook:
    build:
      context: ./webhook
      dockerfile: Dockerfile
    container_name: greenbone-webhook
    ports:
      - "${WEBHOOK_PORT:-8081}:8081"
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - NATS_URL=nats://nats:4222
      - NATS_TOKEN=${NATS_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    restart: unless-stopped

  # ===========================================
  # VoidProbe Server - Tunnel Termination
  # ===========================================
  voidprobe-server:
    image: voidprobe-server:latest  # TODO: definir imagem
    container_name: greenbone-voidprobe-server
    ports:
      - "${VOIDPROBE_SERVER_PORT:-9000}:9000"
    environment:
      - VOIDPROBE_TOKEN=${VOIDPROBE_SERVER_TOKEN}
    restart: unless-stopped

networks:
  default:
    name: greenbone-central
